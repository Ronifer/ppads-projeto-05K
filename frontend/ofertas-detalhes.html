<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="manifest" href="/manifest.json">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <!-- Favicons -->
    <link rel="apple-touch-icon" href="images/icons/apple-icon.png">
    <link rel="icon" href="images/icons/favicon.png">
    <title>
        Easy Market
    </title>
    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons"
    />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/css/material-dashboard.css?v=2.0.0">
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEGnhQ8xLUclq-UNFiwBFpzL5iskFgy4c&libraries=places"></script>
    <!-- Documentation extras -->
    <!-- CSS Just for demo purpose, don't include it in your project -->
    <link href="assets/assets-for-demo/demo.css" rel="stylesheet" />
    <!-- iframe removal -->
</head>
<!-- AIzaSyDYNWiio7Q4NN6mggXslUcTkMawnOg2tII  -->
<!-- AIzaSyCEGnhQ8xLUclq-UNFiwBFpzL5iskFgy4c -->

<body class="">
    <div class="wrapper">
        <div class="sidebar" data-color="purple" data-background-color="white" data-image="assets/img/sidebar-1.jpg">
            <!--
        Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"

        Tip 2: you can also add an image using data-image tag
    -->
            <div class="logo">
                <a href="#" class="simple-text logo-normal">
                    Easy Market
                </a>
            </div>
            <div class="sidebar-wrapper">
                <ul class="nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="../examples/dashboard.html">
                            <i class="material-icons">dashboard</i>
                            <p>Home</p>
                        </a>
                    </li>
                    <li class="nav-item active-pro">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="material-icons">unarchive</i>
                            <p>Sair</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <img src="assets/img/loading.gif" style="margin: 15% auto; display:none" id="loading" />
        <div class="main-panel" id="mainContent">
            <!-- Navbar -->


            <img src="assets/img/loading.gif" style="margin: 15% auto; display:none" id="loading" />

            <nav class="navbar navbar-expand-lg navbar-transparent  navbar-absolute fixed-top">
                <div class="container-fluid">
                    <div class="navbar-wrapper">
                        <a class="navbar-brand" href="#pablo" id="tituloPagina">Oferta</a>
                    </div>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="navbar-toggler-icon icon-bar"></span>
                        <span class="navbar-toggler-icon icon-bar"></span>
                        <span class="navbar-toggler-icon icon-bar"></span>
                    </button>
                </div>
            </nav>
            <!-- End Navbar -->
            <div class="content" style="max-height: 82vh;min-height: auto;">
                <div class="col-md-12">
                    <div id="map" style="display: none; z-index: 2;
                        width: 100%;
                        height: 70vh;
                        padding: 10px;
                        margin-top: 0;"></div>
                    <div class="card card-profile" id="conteudoCard">
                        <div class="card-avatar">
                        </div>
                        <div class="card-body">
                            <div id="testeImagem" style="
                            width: 30%;
                            margin: 40px auto;
                        "></div>
                            <h6 class="card-category text-gray" id="nomeMercado"></h6>
                            <h4 class="card-title" id="nomeProduto"></h4>
                            <p class="card-description" id="descriptionProduto">

                            </p>
                            <a href="#" class="btn btn-danger btn-round" onclick="setExpired()">Promoção Expirada?</a>
                            <a href="#" class="btn btn-primary btn-round" onclick="voltar()">Voltar</a>
                            <a href="#" class="btn btn-warning btn-round" onclick="viewMapa()">Mapa</a>
                        </div>
                    </div>
                </div>
                <br/>
                <a href="#" class="btn btn-primary btn-round" onclick="voltar()" id="voltarMapa" style="display:none">Voltar</a>
            </div>

            <footer class="footer ">
                <div class="copyright pull-right">
                    &copy;
                    <script>
                        document.write(new Date().getFullYear())
                    </script> Easy Market
                </div>
        </div>
        </footer>
    </div>
    </div>


</body>
<!--   Core JS Files   -->
<script src="assets/js/core/jquery.min.js"></script>
<script src="assets/js/core/popper.min.js"></script>
<script src="assets/js/bootstrap-material-design.js"></script>
<script src="assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
<!--  Charts Plugin, full documentation here: https://gionkunz.github.io/chartist-js/ -->
<script src="assets/js/plugins/chartist.min.js"></script>
<!-- Library for adding dinamically elements -->
<script src="assets/js/plugins/arrive.min.js" type="text/javascript"></script>
<!--  Notifications Plugin, full documentation here: http://bootstrap-notify.remabledesigns.com/    -->
<script src="assets/js/plugins/bootstrap-notify.js"></script>
<!-- Material Dashboard Core initialisations of plugins and Bootstrap Material Design Library -->
<script src="assets/js/material-dashboard.js?v=2.0.0"></script>
<!-- demo init -->
<script src="assets/js/plugins/demo.js"></script>
<script>
    var lat;
    var long;
    function getLocation() {

    }
    function showPosition(position) {
        lat = position.coords.latitude
        long = position.coords.longitude
        console.log(lat)
        console.log(long)
    }

    var promocoesDetalhes
    function viewMapa() {
        $('#map').css("display", "")
        $('#conteudoCard').css("display", "none")
        $("#voltarMapa").css("display", "")
    }
    function logout() {
        localStorage.clear()
        location.href = "index.html"
    }

    function voltar() {
        location.href = "home.html"
    }

    function getPromocao() {
        let promocao = JSON.parse(localStorage.getItem("promocaoDetalhe"))
        localStorage.removeItem("promocaoDetalhe")
        promocoesDetalhes = promocao
        initMap()
        $('#testeImagem').html(`<img style="width:100%" class="img" src="${promocao.market.logo}" />`)
        $('#nomeMercado').html(promocao.market.title)
        $('#nomeProduto').html(promocao.product.title)
        $('#tituloPagina').html(promocao.product.title)
        $('#descriptionProduto').html("Promoção: " + promocao.description)
        $('#descriptionProduto').append("<br/>Produto: " + promocao.product.description)
    }

    function setExpired() {
        console.log(promocoesDetalhes.id)
        $('#mainContent').css("display", "none")
        $('#loading').css("display", "grid")
        $.ajax({
            type: "PUT",
            cache: false,
            url: "http://35.196.2.136/api/promotions/inativar/" + promocoesDetalhes.id,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (promotion) {
                $.notify({
                    icon: "notifications",
                    message: "Promoção Inativada com Sucesso, Aguarde..."

                }, {
                        type: 'success',
                        timer: 3000,
                        placement: {
                            from: 'top',
                            align: 'center'
                        }
                    });
                setInterval(function () { location.href = "home.html"; }, 3000);

            }
        })
    }

    var map;
    var service;
    var infowindow;

    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                console.log("entrou")
                
                console.log(position)
                var pyrmont = new google.maps.LatLng(position.coords.latitude, position.coords.longitud);

                map = new google.maps.Map(document.getElementById('map'), {
                    center: pyrmont,
                    zoom: 15
                });

                var request = {
                    location: pyrmont,
                    radius: '500',
                    query: promocoesDetalhes.market.title
                };
                infowindow = new google.maps.InfoWindow();
                service = new google.maps.places.PlacesService(map);
                service.textSearch(request, callback);
            });
        } else {
            alert("Não foi possivel Obter sua localização")
        }

    }

    function callback(results, status) {
        console.log("callback")
        if (status == google.maps.places.PlacesServiceStatus.OK) {
            for (var i = 0; i < results.length; i++) {
                var place = results[i];
                createMarker(results[i]);
                //console.log(results[i])
            }
        }
    }
    function createMarker(place) {
        var marcador = {
            url: 'images/icons/marcador-maps.png',
            // This marker is 20 pixels wide by 32 pixels high.
            size: new google.maps.Size(20, 20),

        };

        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            icon: marcador
        });

        google.maps.event.addListener(marker, 'click', function () {
            infowindow.setContent(place.name);
            infowindow.open(map, this);
        });
    }




    $(document).ready(function () {
        getPromocao()
        let user = JSON.parse(localStorage.getItem("user"))

    })
</script>

</html>